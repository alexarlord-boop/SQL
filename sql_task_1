/****** Скрипт для команды задачи 2  ******/
USE AdventureWorks2016;

SELECT year(ModifiedDate) AS YearOfProft, month(ModifiedDate) AS MonthOfProfit, SUM (LineTotal) AS TotalProfit
FROM Sales.SalesOrderDetail
GROUP BY year(ModifiedDate), month(ModifiedDate)
ORDER BY year(ModifiedDate), month(ModifiedDate)



/****** Скрипт для задачи 3  ******/
SELECT TOP 10  [City], COUNT (BusinessEntityID) as [PPriority]
FROM Sales.vIndividualCustomer 
WHERE [City] IN (SELECT [City]
				FROM [Person].[Address] 
				EXCEPT
				SELECT City FROM [Sales].[vStoreWithAddresses])
GROUP BY [City]
ORDER BY [PPriority] desc

/****** Скрипт для задачи 4  ******/

SELECT [Sales].[SalesOrderDetail].[SalesOrderID], [Sales].[SalesOrderDetail].[ProductID], [OrderQty], [Customer].[PersonID]
INTO #TmpRaw
FROM [Sales].[SalesOrderDetail] 
JOIN [Sales].[SalesOrderHeader]
ON [SalesOrderDetail].[SalesOrderID] = [SalesOrderHeader].[SalesOrderID]
JOIN [Sales].[Customer]
ON [Customer].[CustomerID] = [SalesOrderHeader].[CustomerID]

SELECT  [PersonID], [ProductID], SUM(OrderQty) AS [Total]
INTO [#TmpCounted] FROM [#TmpRaw]
GROUP BY [PersonID], [ProductID]

SELECT [LastName], [FirstName], [Name], [Total]
FROM [Person].[Person]
JOIN [#TmpCounted]
ON [#TmpCounted].[PersonID] = [Person].[Person].[BusinessEntityID]
JOIN [Production].[Product]
ON [Product].[ProductID] = [#TmpCounted].[ProductID]
WHERE Total > 15
ORDER BY Total desc

/****** Скрипт для задачи 5  ******/
USE AdventureWorks2016;

SELECT OrderDate, LastName, FirstName, STRING_AGG(CONVERT(NVARCHAR(max), CONCAT(Name, ' ', 'Количество: ', OrderQty, ' шт.')), CHAR(13)) AS OrderConent
FROM (SELECT MIN(OrderDate) AS FirstOrder, BusinessEntityID
		FROM Sales.SalesOrderHeader
		JOIN Person.Person
		ON Person.BusinessEntityID=SalesOrderHeader.CustomerID
		GROUP BY BusinessEntityID) AS PersonDate
JOIN Person.Person ON PersonDate.BusinessEntityID=Person.BusinessEntityID
JOIN Sales.SalesOrderHeader AS SalesOrder 
ON (PersonDate.BusinessEntityID=SalesOrder.CustomerID 
	AND PersonDate.FirstOrder=SalesOrder.OrderDate)
JOIN Sales.SalesOrderDetail AS Details 
ON (Details.SalesOrderID=SalesOrder.SalesOrderID)
JOIN Production.Product ON Details.ProductID=Product.ProductID 
GROUP BY  Person.BusinessEntityID, OrderDate, LastName, FirstName
ORDER BY OrderDate desc


